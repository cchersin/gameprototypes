<!doctype html>
<meta charset="utf-8">
<title>Uberfranz</title>
<body>
<script src="js/pixi.js"></script>
<script src="js/utils.js"></script>
<script>

function onLoad(){

///Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    Sprite = PIXI.Sprite,
    Rectangle = PIXI.Rectangle;

//Create the renderer
var renderer = autoDetectRenderer(256, 256, {antialias: false, transparent: false, resolution: 1});
renderer.backgroundColor = 0x061639;

renderer.view.style.position = "absolute";
renderer.view.style.display = "block";
renderer.autoResize = true;
renderer.resize(window.innerWidth, window.innerHeight);

//Add the canvas to the HTML document
document.body.appendChild(renderer.view);


//Create a container object called the `stage`
var stage = new Container();
var mainSprite = null;
var cinghialiSprite = [];
var state = null;
var platforms = [];

//Capture the keyboard arrow keys
  var left = leftArrow,
      up = upArrow,
      right = rightArrow,
      down = downArrow;


loader
  .add("uberfranzIdle", "images/uberfranz.png")
  .add("cinghialeIdle", "images/cinghiale.png")
  .add("tiles", "images/tiles.gif")
  .load(setup);


var movementSpeed = 0.8;
var movementSpeedInAir = 0.1;
var gravity = 0.1;
var velocityMultiplier = 0.96;
var velocityMultiplierLand = 0.8;
var jumped = false;
var jumpHeight = 7;
var runJumpMultipler = 0.1;
var playerDead = 0;
var idleCostume = null;
var moving = false;
var xCollision = false;
var yCollision = false;
var playerMovementAnimation = false;

var TILE_SIZE = 48;



function addTile(row,col){
  //Create the `tileset` sprite from the texture
  var tileTexture = resources.tiles.texture;

  //Create a rectangle object that defines the position and
  //size of the sub-image you want to extract from the texture
  var tileRectangle = new Rectangle(0, TILE_SIZE, TILE_SIZE, TILE_SIZE);

  //Tell the texture to use that rectangular section
  tileTexture.frame = tileRectangle;

  //Create the sprite from the texture
  var tile = new Sprite(tileTexture);

  //Position the rocket sprite on the canvas
  tile.x = col * TILE_SIZE;
  tile.y = row * TILE_SIZE;

  //Add the rocket to the stage
  stage.addChild(tile);
}

function addPlatform(row,col){
  //Create the `tileset` sprite from the texture
  var tileTexture = resources.tiles.texture;

  //Create a rectangle object that defines the position and
  //size of the sub-image you want to extract from the texture
  var tileRectangle = new Rectangle(0, 0, TILE_SIZE * 6, TILE_SIZE);

  //Tell the texture to use that rectangular section
  tileTexture.frame = tileRectangle;

  //Create the sprite from the texture
  var platform = new Sprite(tileTexture);

  //Position the rocket sprite on the canvas
  platform.x = col * TILE_SIZE;
  platform.y = row * TILE_SIZE;

  //Add the rocket to the stage
  stage.addChild(platform);

  platforms.push(platform);
}

function hitPlatform(){
  for(var i= 0; i < platforms.length; i++){
   if(hitTestRectangle(mainSprite,platforms[i]))
    return true;
  }

  return false;
}


function setup() {

  idleCostume = resources.uberfranzIdle.texture;

  var uberfranzSprite = new Sprite(
    idleCostume
  );

  /*for(var row = 0; row <= 10; row++ ){
    for(var col = 0; col <= 10; col++ ){
      addTile(row,col);
    }
  }*/

  addPlatform(3,8);
  addPlatform(5,4);
  addPlatform(7,0);

  mainSprite = uberfranzSprite;

  mainSprite.x = 0;
  mainSprite.y = 0;
  mainSprite.vx = 0;
  mainSprite.vy = 0;

  stage.addChild(mainSprite);

  for(var i = 0; i < 2; i++ ){
    cinghialiSprite[i] = new Sprite(
      resources.cinghialeIdle.texture
    );

    cinghialiSprite[i].x = TILE_SIZE * 5 + (TILE_SIZE*i*2);
    cinghialiSprite[i].y = (TILE_SIZE * 5) - cinghialiSprite[i].height;
    cinghialiSprite[i].vx = -1;
    cinghialiSprite[i].vy = 0;

    stage.addChild(cinghialiSprite[i]);

  }

/*
      //Left arrow key `press` method
  left.press = function() {

    //Change the cat's velocity when the key is pressed
    mainSprite.vx = -5;
    mainSprite.vy = 0;
  };

  //Left arrow key `release` method
  left.release = function() {

    //If the left arrow has been released, and the right arrow isn't down,
    //and the cat isn't moving vertically:
    //Stop the cat
    if (!right.isDown && mainSprite.vy === 0) {
      mainSprite.vx = 0;
    }
  };

  //Up
  up.press = function() {
    mainSprite.vy = -5;
    mainSprite.vx = 0;
  };
  up.release = function() {
    if (!down.isDown && mainSprite.vx === 0) {
      mainSprite.vy = 0;
    }
  };

  //Right
  right.press = function() {
    mainSprite.vx = 5;
    mainSprite.vy = 0;
  };
  right.release = function() {
    if (!left.isDown && mainSprite.vy === 0) {
      mainSprite.vx = 0;
    }
  };

  //Down
  down.press = function() {
    mainSprite.vy = 5;
    mainSprite.vx = 0;
  };
  down.release = function() {
    if (!up.isDown && mainSprite.vx === 0) {
      mainSprite.vy = 0;
    }
  };*/

  state = play;
  gameLoop();

}


function gameLoop() {

  //Loop this function at 60 frames per second
  requestAnimationFrame(gameLoop);

  //Update the current game state:
  state();

  //Render the stage to see the animation
  renderer.render(stage);
}

function play() {

  mainSprite.texture = idleCostume;
  moving = false;
  xCollision = false;
  yCollision = false;

  mainSprite.x += mainSprite.vx;
  if(hitPlatform()){
    xCollision = true;
  }
  if(xCollision){
      mainSprite.y += Math.abs(mainSprite.vx/2);
      if(hitPlatform()){
        mainSprite.y += Math.abs(mainSprite.vx/2);
        if(hitPlatform()){
          mainSprite.y += Math.abs(mainSprite.vx/2);
          if(hitPlatform()){
            mainSprite.y += Math.abs(mainSprite.vx/2);
            if(hitPlatform()){
               mainSprite.y += - Math.abs(mainSprite.vx/2)*4;
               mainSprite.x += -mainSprite.vx;
               mainSprite.vx = 0;
            } else {
              mainSprite.y += -Math.abs(mainSprite.vx/2);
            }
          } else {
            mainSprite.y += -Math.abs(mainSprite.vx/2);
          }
        } else {
          mainSprite.y += -Math.abs(mainSprite.vx/2);
        }
      } else {
        mainSprite.y += -Math.abs(mainSprite.vx/2);
      }
  }
  
  mainSprite.y += mainSprite.vy;
  if(hitPlatform()){
    yCollision = true;
  }

  if(yCollision){
    mainSprite.vx = mainSprite.vx * velocityMultiplierLand;
    if(upArrow.isDown && mainSprite.vy > 0){
      mainSprite.vy = -(jumpHeight * (1 + Math.abs(mainSprite.vx * runJumpMultipler)));
      jumped = true;
      // Producti suono jump
    } else {
       if(mainSprite.vy > 0){
          jumped = false;
       }
       mainSprite.y += - mainSprite.vy;
       mainSprite.vy = 0;
    }
  }

  if( jumped && (!upArrow.isDown && mainSprite.vy < 0)){
    mainSprite.vy = mainSprite.vy * 0.6;
  }

  // Se sta toccando die allora
  // Se sta toccando win allora

  if(leftArrow.isDown){
    moving = true;
    // punta in direzione 90
    if(yCollision){
      mainSprite.vx += -movementSpeed;
    } else {
      mainSprite.vx += -movementSpeedInAir;
    }
  } else {
    if(rightArrow.isDown){
        moving = true;
        //punta in direzione -90
        if(yCollision){
           mainSprite.vx += movementSpeed;
        } else {
           mainSprite.vx += movementSpeedInAir;
        }
    } else {
        playerMovementAnimation = false;
        if(jumped){
          // passa al costume jump
        } else {
          // passa al costume idle
          if(yCollision){
            playerMovementAnimation += Math.abs(mainSprite.vx * 1);
            if(playerMovementAnimation < 10){
              //Passa al costume run1
            } else if(playerMovementAnimation < 20){
              // Passa al costume run 2
            } else if(playerMovementAnimation < 30){
              // Passa al costume run 3 
            } else if(playerMovementAnimation < 40){
              // passa al costume run 2
            } else {
              playerMovementAnimation += -40;
               // Passa al costume run 1 
            }
             
          } else {
            // passa al costume idle
          }
        }

    }
  }

  

  mainSprite.vx = mainSprite.vx * velocityMultiplier;
  mainSprite.vy = mainSprite.vy * velocityMultiplier;
  mainSprite.vy += gravity;
 
  
  for(var i = 0; i < cinghialiSprite.length; i++){

  	cinghialiSprite[i].x += cinghialiSprite[i].vx; 
    cinghialiSprite[i].y += cinghialiSprite[i].vy; 

    if(cinghialiSprite[i].x > TILE_SIZE * 9){
      cinghialiSprite[i].vx = -1;
      cinghialiSprite[i].scale.x = 1;
    } else if(cinghialiSprite[i].x < TILE_SIZE * 5){
      cinghialiSprite[i].vx = 1;
      cinghialiSprite[i].scale.x = -1;
    }

	  //check for a collision between the cat and the box
	  if (hitTestRectangle(mainSprite, cinghialiSprite[i])) {
	    console.log('hit!!!');
    } 
  }
}

}

onLoad();
  




</script>

</body>
<!doctype html>
<meta charset="utf-8">
<!--<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densityDpi=device-dpi" />-->
<title>Uberfranz</title>
<head>
<style>
.main {
  position: relative;
  /*height: 100px;
  width: 100%;*/
  overflow: hidden;
  /*border: 1px solid blue;*/
}

.punch_left {
  position: fixed;
  top: 100px;
  right: 0px;
  z-index: 9999;
}

.start_button {
  position: fixed;
  top: 0px;
  left: 0px;
  max-width: 1100px;
  z-index: 9999;
}

.loading {
  position: fixed;
  top: 0px;
  left: 0px;
  max-width: 1100px;
  z-index: 9999;
}


.punch_right {
  position: fixed;
  top: 100px;
  left: 0px;
  z-index: 9999;
}

.healt_bar_container {
  position: fixed;
  top: 0px;
  left: 0px;
  right: 0px;
  max-width: 1100px;
  height: 20px;
  z-index: 999;
}

.control_layer {
  position: fixed;
  top: 0px;
  left: 0px;
  height: 200px;
  width: 100%;
  max-width: 1100px;
  z-index:999;
  /*border: 1px solid blue;*/
 }

.healt_bar {
  position: absolute;
  top: 20px;
  right: 20px;
  height: 10px;
  width: 150px;
  background-color: red;
}


.healt_bar_inner {
  position: absolute;
  top: 0px;
  right: 0px;
  height: 10px;
  width: 150px;
  background-color: blue;
}

.display {
  position: absolute;
  height: 100px;
  top: 0px;
  left: 0px;
 }
</style>

<script src="js/jquery-3.1.1.min.js"></script>
<script src="js/pixi.js"></script>
<script src="js/sound.js"></script>
<script src="js/tink.js"></script>
<script src="js/utils.js"></script>


<script>


$(function(){

var main = $('.main');

if(navigator.userAgent.includes('Silk/')){
  $(document.body).html('Silk browser not suppported');
  return;
}

function detectmob() { 
 if( navigator.userAgent.match(/Android/i)
 || navigator.userAgent.match(/webOS/i)
 || navigator.userAgent.match(/iPhone/i)
 || navigator.userAgent.match(/iPad/i)
 || navigator.userAgent.match(/iPod/i)
 || navigator.userAgent.match(/BlackBerry/i)
 || navigator.userAgent.match(/Windows Phone/i)
 ){
    return true;
  }
 else {
    return false;
  }
}

var spriteScale = 1;


if(detectmob()){
  $(".punch_right").show();
  $(".punch_left").show();
  spriteScale = 1.5;
}

var fitToWindow = function(){
  var window_width = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
  var window_height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
  main.width(window_width);
  main.height(window_height);

  $(".start_button").css("left", ((window_width - $(".start_button").width()) / 2) + "px");
  $(".start_button").css("top", ((window_height - $(".start_button").height()) / 2) + "px");

  $(".loading").css("left", ((window_width - $(".loading").width()) / 2) + "px");
  $(".loading").css("top", ((window_height - $(".loading").height()) / 2) + "px");
};

fitToWindow();

$(window).resize(function(){
  fitToWindow();
});

// Listen for orientation changes
window.addEventListener("orientationchange", function() {
  fitToWindow();
}, false);


var levels = [{
  container:{width:20,height:20},
  mainCharacter:{row:17,col:10},
  //mainCharacter:{row:7.5,col:3},
  win:{row:3.2,col:15},
  platforms:[{row:17,col:0, width:20, height:3},
         {row:0,col:0, width:1, height:21},
         {row:0,col:19, width:1, height:21},
         {row:2.5,col:11, width:8, height:1},
         {row:5,col:7, width:4, height:1},
         {row:6.5,col:1, width:3, height:1},
         {row:9,col:1, width:10, height:1, enemies : [{col:1}]},
         {row:10.8,col:13, width:6, height:1},
         {row:14,col:5, width:14, height:1, enemies : [{col:1}]}],
         clouds : [{row:12,col:2}],
         signs : [{row:17,col:8,direction:'l'}]
       },
   {
  container:{width:20,height:20},
  mainCharacter:{row:17,col:10},
  //mainCharacter:{row:7.5,col:3},
   win:{row:4.2,col:15},
  platforms:[{row:17,col:0, width:20, height:3},
         {row:0,col:0, width:1, height:21},
         {row:0,col:19, width:1, height:21},
         {row:3.5,col:11, width:8, height:1},
         {row:6,col:7, width:4, height:1},
         {row:7.5,col:1, width:3, height:1},
         {row:10,col:1, width:9, height:1, enemies : [{col:1},{col:3}]},
         {row:11.8,col:12, width:7, height:1},
         {row:14.5,col:5, width:14, height:1, enemies : [{col:1}]}],
         clouds : [{row:14,col:5}],
         signs : [{row:17,col:8,direction:'l'}]
       }
];



var currLevel = 0;
var platforms = null; 
var TILE_SIZE_H = 60 * spriteScale;
var TILE_SIZE_V = 45 * spriteScale;
var CONTROL_BUTTON_WIDTH = 0;
var CONTROL_BUTTON_HEIGHT = 0;
var power = 100;


///Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    Sprite = PIXI.Sprite,
    Rectangle = PIXI.Rectangle;

var rendererWidth = levels[currLevel].container.width*TILE_SIZE_H+CONTROL_BUTTON_WIDTH*2;
var rendererHeight = levels[currLevel].container.height*TILE_SIZE_V;

//Create the renderer
var renderer = autoDetectRenderer(rendererWidth, rendererHeight, 
                                  {antialias: false, transparent: false, resolution: 1});
renderer.backgroundColor = 0x09a6df;

renderer.view.style.position = "absolute";
renderer.view.style.display = "block";
renderer.autoResize = true;
//renderer.resize(window.innerWidth, window.innerHeight);


//Add the canvas to the HTML document
var display = $("#display");

display[0].appendChild(renderer.view);


var controlLayerRenderer = autoDetectRenderer($('#control_layer').width(), $('#control_layer').height(), 
                                  {antialias: false, transparent: true, resolution: 1});
//controlLayerRenderer.view.style.position = "absolute";
//controlLayerRenderer.view.style.display = "block";
controlLayerRenderer.autoResize = true;

$('#control_layer')[0].appendChild(controlLayerRenderer.view);

//display.width(rendererWidth);
//display.height(rendererHeight);

// TODO RESTART!!!!
// TODO dimesioni sprites 

var t = new Tink(PIXI, controlLayerRenderer.view);


var stage = null;
var controlLayerStage = null;
var uberfranzSprite = null;
var mainSprite = null;
var cinghialiSprite = [];
var doorSprite = null;
var winSprite = null;
//var punchLeftSprite = null;
//var punchRightSprite = null;
var restartSprite = null;
var state = null;
var greenTile = null;
var weaponCount = 0;
var stageX = 0;

//Capture the keyboard arrow keys
var left = leftArrow,
    up = upArrow,
    right = rightArrow,
    down = downArrow;
var weaponKey = keyboard(65);


loader
  .add("uberfranzIdleR", "images/uberfranz_idle_r.png")
  .add("uberfranzRun1R", "images/uberfranz_run1_r.png")
  .add("uberfranzRun2R", "images/uberfranz_run2_r.png")
  .add("uberfranzRun3R", "images/uberfranz_run3_r.png")
  .add("uberfranzJumpR", "images/uberfranz_jump_r.png")
  .add("uberfranzWeaponR", "images/uberfranz_weapon_r.png")
  .add("uberfranzIdleL", "images/uberfranz_idle_l.png")
  .add("uberfranzRun1L", "images/uberfranz_run1_l.png")
  .add("uberfranzRun2L", "images/uberfranz_run2_l.png")
  .add("uberfranzRun3L", "images/uberfranz_run3_l.png")
  .add("uberfranzJumpL", "images/uberfranz_jump_l.png")
  .add("uberfranzWeaponL", "images/uberfranz_weapon_l.png")
  .add("uberfranzDead", "images/uberfranz_dead.png")
  //.add("punch", "images/punch.png")
  .add("cinghialeIdleL", "images/cinghiale_l.png")
  .add("cinghialeIdleR", "images/cinghiale_r.png")
  .add("cinghialeBeated", "images/cinghiale_beated.png")
  .add("win", "images/win.png")
  .add("sign_l", "images/sign_l.png")
  .add("sign_r", "images/sign_r.png")
  .add("tile", "images/tile.png")
  .add("cloud", "images/cloud.png")
  
  .load(onSetupImages);

  

var movementSpeed = 0.8;
var movementSpeedInAir = 0.1;
var gravity = 0.1;
var velocityMultiplier = 0.96;
var velocityMultiplierLand = 0.8;
var jumped = false;
var jumpHeight = 7 * spriteScale;
var runJumpMultipler = 0.2;
var idleCostume = null;
var moving = false;
var xCollision = false;
var oldYCollions = false;
var yCollision = false;
var playerMovementAnimation = 0;
var jumpSound = null;
var enemyHitSound = null;
var dieSound = null;
var punchSound = null;
var powerupSound = null;
var enterDoorSound = null;
var winSound = null;
var leftGesture = false;
var rightGesture = false;
var upGesture = false;
var enemyCollision = false;
var oldEnemyCollision = false;
var cinghialeIdleL = null;
var cinghialeIdleR = null;
var cinghialeBeated = null;



function createCloud(row,col){

  var cloud = new Sprite(resources.cloud.texture);
  cloud.scale.x = spriteScale;
  cloud.scale.y = spriteScale;

  cloud.x = col * TILE_SIZE_H;
  cloud.y = row * TILE_SIZE_V;
  
  return cloud;
}

function createSign(row,col,direction){

  var sign = new Sprite(direction == 'l' ? resources.sign_l.texture : resources.sign_r.texture);
  sign.scale.x = spriteScale;
  sign.scale.y = spriteScale

  sign.x = col * TILE_SIZE_H ;
  sign.y = row * TILE_SIZE_V - sign.height;
   
  return sign;
}

function createPlatformSprite(row,col,width,height,tileTexture){

// ParticleContainer
  var platform = new Container();
  var platform0 = new PIXI.ParticleContainer(100,{rotation:false,alpha:false,scale:false,uvs:false});

  for(var i=0; i < width; i++){
    for(var j=0; j < height; j++){
       var tile = new Sprite(resources.tile.texture);
       tile.scale.x = spriteScale;
       tile.scale.y = spriteScale;
       tile.x = CONTROL_BUTTON_WIDTH + i * TILE_SIZE_H;
       tile.y = j * TILE_SIZE_V;
       platform0.addChild(tile);
    }
  }

  /*var platform0 = new PIXI.extras.TilingSprite(resources.tile.texture,width * TILE_SIZE_H,height*TILE_SIZE_V);*/

  platform.addChild(platform0);

  var border1 = new PIXI.Graphics();
  border1.lineStyle(1, 0x6b6060, 1);
  border1.beginFill(0x6b6060);
  border1.drawRect(0, 0, TILE_SIZE_H * width -2, 5);
  border1.endFill();
  border1.x = 0;
  border1.y = 0;
  platform.addChild(border1);

  var border2 = new PIXI.Graphics();
  border2.lineStyle(1, 0x181512, 1);
  border2.beginFill(0x181512);
  border2.drawRect(0, 0, TILE_SIZE_H * width -2, 5);
  border2.endFill();
  border2.x = 0;
  border2.y = 5;
  platform.addChild(border2);


  platform.x = col * TILE_SIZE_H;
  platform.y = row * TILE_SIZE_V;

  return platform;
}

function hitPlatform(){
  for(var i= 0; i < platforms.length; i++){
   if(hitTestRectangle(mainSprite,platforms[i].sprite))
    return true;
  }

  return false;
}

var leftCostumes = function(){
    idleCostume = resources.uberfranzIdleL.texture;
    run1Costume = resources.uberfranzRun1L.texture;
    run2Costume = resources.uberfranzRun2L.texture;
    run3Costume = resources.uberfranzRun3L.texture;
    jumpCostume = resources.uberfranzJumpL.texture;
    weaponCostume = resources.uberfranzWeaponL.texture;
}

var rightCostumes = function(){
    idleCostume = resources.uberfranzIdleR.texture;
    run1Costume = resources.uberfranzRun1R.texture;
    run2Costume = resources.uberfranzRun2R.texture;
    run3Costume = resources.uberfranzRun3R.texture;
    jumpCostume = resources.uberfranzJumpR.texture;
    weaponCostume = resources.uberfranzWeaponR.texture;
}

var lastTap = 0;
var lastTapX = 0;
var lastTapY = 0;
function detectActions(touches){

 if(touches.length == 2){  
    upGesture = true;
  } else { 
  
    leftGesture = false;
    rightGesture = false;
    upGesture = false;

   var window_width = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
  

    for (var i = touches.length - 1; i >= 0; i--) {
      if(touches[i].clientX < window_width / 2  ){
        leftCostumes();
        leftGesture = true;
      } else if((touches[i].clientX > window_width / 2 ) && touches[i].clientY > 100){
        rightCostumes();
        rightGesture = true;
      } 
    }
  }
}

$(".main").on("touchstart", function(ev) {
    var e = ev.originalEvent;
    //console.log(e.touches);

/*    var currentTime = new Date().getTime();
    var tapLength = currentTime - lastTap;
    lastTap = currentTime;
    var deltaY = Math.abs(lastTapX - (e.touches.length > 0 ? e.touches[0].clientX : 0));
    var deltaX = Math.abs(lastTapY - (e.touches.length > 0 ? e.touches[0].clientY : 0));
    lastTapX = e.touches.length > 0 ? e.touches[0].clientX : 0;
    lastTapY = e.touches.length > 0 ? e.touches[0].clientY : 0;

    console.log("LAST" + lastTapX + ' - ' + lastTapY);
    console.log(deltaX + ' - ' + deltaY);

    if(e.touches.length == 1 && deltaX < 10 && deltaY < 10 && tapLength < 750 && tapLength > 0) {
      punch();
      return;
    }*/ 
    

    detectActions(e.touches);
});

$(".main").on("touchend", function(ev) {
    var e = ev.originalEvent;
    //console.log(e.touches);
    
  
  
    detectActions(e.touches);
});

document.body.addEventListener('touchmove', function(event) {
  event.preventDefault();
}, false); 

var punch = function(){
   if(state != play)
      return;

    punchSound.play();
    weaponCount++;
    setTimeout(function(){ if( weaponCount > 0 )
                              weaponCount--; }, 500);
    animation(bounce2,function(delta) {
      console.log(delta);
        //$("#display").css("left", to*delta + "px");    
        //stage.x = to*delta;
        stageX = 10*(delta);
        //stageX = - 20;
    });
}


$(".punch_left").click(function(event) {
    punch();
    event.stopPropagation();
});

$(".punch_right").click(function(event) {
    punch();
    event.stopPropagation();
});

$(".punch_left").on("touchstart", function(event) {
    punch();
    event.stopPropagation();
});

$(".punch_right").on("touchstart", function(event) {
    punch();
    event.stopPropagation();
});

function start(){
  $(".start_button").hide();
    currLevel = 0;
    stage = setupLevel(currLevel);
    state = play;
    punch();
}

$(".start_button").on("click", function(ev) {
    start();
});

$(".start_button").on("touchstart", function(ev) {
    start();
});


function onSetupImages() {

  weaponCostume = resources.uberfranzWeaponR.texture;
  deadCostume = resources.uberfranzDead.texture;
  /*uberfranzBeatEnemy = resources.uberfranzBeatEnemy.texture;*/
  cinghialeIdleL = resources.cinghialeIdleL.texture;
  cinghialeIdleR = resources.cinghialeIdleR.texture;
  cinghialeBeated = resources.cinghialeBeated.texture;

  rightCostumes();

  uberfranzSprite = new Sprite(
    idleCostume
  );

  //Load the sounds
  sounds.load([
    "sounds/jump.wav",
    "sounds/enemy_hit.wav",  
    "sounds/die.wav",  
    "sounds/punch.wav",
    "sounds/enter_door.wav",
    "sounds/powerup.wav",
    "sounds/win.wav"
   ]);

  sounds.whenLoaded = onSetupSounds;


}

function onSetupSounds(){
    jumpSound = sounds["sounds/jump.wav"];
    enemyHitSound = sounds["sounds/enemy_hit.wav"];
    dieSound = sounds["sounds/die.wav"];
    punchSound = sounds["sounds/punch.wav"];
    enterDoorSound = sounds["sounds/enter_door.wav"];
    powerupSound = sounds["sounds/powerup.wav"];
    winSound = sounds["sounds/win.wav"];

    
    state = endWin;
    stage = setupLevel(currLevel);
    setupControlLayer();

    
    $('.loading').hide();
    $('.start_button').show();
    gameLoop();
};

function setupControlLayer(){

  controlLayerStage = new Container();
  

  var pointer = t.makePointer();
  pointer.visible=true;
  pointer.x=0;
  pointer.y=0;

  /*restartSprite = new PIXI.Text(
          "Restart",
          { font: "64px sans-serif", fill: "white"}
      );

  restartSprite.position.x = 100;
  restartSprite.position.y = 100;
  restartSprite.visible = false;
  controlLayerStage.addChild(restartSprite);

  t.makeInteractive(restartSprite);

  restartSprite.press = function() {
    restartSprite.visible = false;
    currLevel = 0;
    setupLevel();
    state = play;
  };*/
     
  /*if(detectmob()){
    punchLeftSprite = new Sprite(
      resources.punch.texture
    );
    punchLeftSprite.y = 100;
    punchLeftSprite.x = 0;

    punchRightSprite = new Sprite(
      resources.punch.texture
    );

    punchRightSprite.y = 100;
    punchRightSprite.x = document.body.clientWidth - 100;

    controlLayerStage.addChild(punchLeftSprite);
    controlLayerStage.addChild(punchRightSprite);

  
    t.makeInteractive(punchLeftSprite);
    t.makeInteractive(punchRightSprite);

    punchLeftSprite.press = function() {
      console.log('press');
     punch();
    };

    punchRightSprite.press = function()  {
      console.log('press');
      punch();
    };
  }*/
}

function setupLevel(level){

  if(level==0){
    power = 100;
    $(".healt_bar_inner").width($(".healt_bar").width());
    $(".healt_bar_inner").css("right",0);
    
  }

  stageX = 0;
  oldYCollions = false;
  oldEnemyCollision = false;
  playerMovementAnimation = 0;

  var scene = new Container();

  platforms = levels[level].platforms;
  clouds = levels[level].clouds;
  signs = levels[level].signs;
  
  rightCostumes();  
  
  uberfranzSprite.texture = idleCostume;

  for(var i = 0; i < clouds.length; i++){
    clouds[i].sprite = createCloud(clouds[i].row, clouds[i].col);
    scene.addChild(clouds[i].sprite);
  }

 for(var i = 0; i < signs.length; i++){
    signs[i].sprite = createSign(signs[i].row, signs[i].col,signs[i].direction);
    scene.addChild(signs[i].sprite);
  }



  for(var i = 0; i < platforms.length; i++){
    platforms[i].sprite = createPlatformSprite(platforms[i].row, platforms[i].col, platforms[i].width, platforms[i].height,null);
    scene.addChild(platforms[i].sprite);

    if(platforms[i].enemies != null){
      var enemies = platforms[i].enemies;

      for(var j = 0; j < enemies.length; j++ ){
       var cinghialeSprite = new Sprite(
         resources.cinghialeIdleR.texture
       );

       cinghialeSprite.scale.x = spriteScale;
       cinghialeSprite.scale.y = spriteScale;

       cinghialeSprite.x = TILE_SIZE_H * (platforms[i].col + enemies[j].col) + CONTROL_BUTTON_WIDTH;
       cinghialeSprite.y = (TILE_SIZE_V * platforms[i].row) - cinghialeSprite.height;
       cinghialeSprite.vx = 1;
       cinghialeSprite.vy = 0;

       scene.addChild(cinghialeSprite);

       enemies[j].sprite = cinghialeSprite;
      }
    }
  }
  
  /*winSprite = new PIXI.Graphics();
  winSprite.lineStyle(1, 0xEEEEEE, 1);
  winSprite.beginFill(0xCCCCCC);
  winSprite.drawRect(0, 0, 20, 20);
  winSprite.endFill();
  winSprite.x = levels[level].win.col * TILE_SIZE;
  winSprite.y = levels[level].win.row * TILE_SIZE - winSprite.height;
  scene.addChild(winSprite);*/

  doorSprite = new Sprite(
    resources.win.texture
  );
  doorSprite.x = levels[level].win.col * TILE_SIZE_H;
  doorSprite.y = levels[level].win.row * TILE_SIZE_V - doorSprite.height;
  scene.addChild(doorSprite);
  winSprite = doorSprite;

  

  
  mainSprite = uberfranzSprite;

  scene.addChild(mainSprite);

   mainSprite.vx = 0;
  mainSprite.vy = 0;
  mainSprite.scale.x = spriteScale;
  mainSprite.scale.y = spriteScale;
  mainSprite.x = levels[level].mainCharacter.col * TILE_SIZE_H;
  mainSprite.y = levels[level].mainCharacter.row * TILE_SIZE_V - mainSprite.height;

  


  weaponKey.press = function() {
    punch();
  };

  left.press = function(){
    leftCostumes();
  }

  right.press = function(){
     rightCostumes();
  }

 return scene;
}




function gameLoop() {

  //Loop this function at 60 frames per second
  requestAnimationFrame(gameLoop);

  //Update the current game state:
  state();

  //Update Tink
  t.update();

  //Render the stage to see the animation
  renderer.render(stage);
  controlLayerRenderer.render(controlLayerStage);
}

function play() {
  
  oldYCollions = yCollision;
  stage.x = stageX;

  mainSprite.texture = idleCostume;
  moving = false;
  xCollision = false;
  yCollision = false;

 //punchSprite.y = $(window).scrollTop();

  mainSprite.x += mainSprite.vx;
  if(hitPlatform() || mainSprite.x <= TILE_SIZE_H || (mainSprite.x + mainSprite.width) >= TILE_SIZE_H * (levels[currLevel].container.width -1)){
    xCollision = true;
  }
  if(xCollision){
      mainSprite.y += Math.abs(mainSprite.vx/2);
      if(hitPlatform()){
        mainSprite.y += Math.abs(mainSprite.vx/2);
        if(hitPlatform()){
          mainSprite.y += Math.abs(mainSprite.vx/2);
          if(hitPlatform()){
            mainSprite.y += Math.abs(mainSprite.vx/2);
            if(hitPlatform()){
               mainSprite.y += - Math.abs(mainSprite.vx/2)*4;
               mainSprite.x += -mainSprite.vx;
               mainSprite.vx = 0;
            } else {
              mainSprite.y += -Math.abs(mainSprite.vx/2);
            }
          } else {
            mainSprite.y += -Math.abs(mainSprite.vx/2);
          }
        } else {
          mainSprite.y += -Math.abs(mainSprite.vx/2);
        }
      } else {
        mainSprite.y += -Math.abs(mainSprite.vx/2);
      }
  }
  
  mainSprite.y += mainSprite.vy;
  if(hitPlatform()){
    yCollision = true;
  }


  if(!oldYCollions && yCollision){
      animation(bounce,function(delta) {
      //console.log(delta);
        //$("#display").css("left", to*delta + "px");    
        //stage.x = to*delta;
        stage.y = 10*delta;
      });
  }

  if(yCollision){
    mainSprite.vx = mainSprite.vx * velocityMultiplierLand;
    if((upArrow.isDown || upGesture) && mainSprite.vy > 0){
      mainSprite.vy = -(jumpHeight * (1 + Math.abs(mainSprite.vx * runJumpMultipler)));
      jumped = true;
      jumpSound.play();
    } else {
       if(mainSprite.vy > 0){
          jumped = false;
       }
       mainSprite.y += - mainSprite.vy;
       mainSprite.vy = 0;
    }
  }

  if( jumped && (!(upArrow.isDown || upGesture) && mainSprite.vy < 0)){
    mainSprite.vy = mainSprite.vy * 0.6;
  }

  if(hitTestRectangle(mainSprite,winSprite)){
    stage.removeChild(mainSprite);
    if(currLevel == levels.length -1){
      winSound.play();
      state = endWin;
      setTimeout(function(){
        $(".start_button").show();
        //restartSprite.visible = true;
      }, 500);
      
    } else {
      enterDoorSound.play();
      state = changingLevel;
      currLevel++; 
      setTimeout(function(){
        stage = setupLevel(currLevel);
        state = play;
      }, 500);
    }
    return;
  }


  if(leftArrow.isDown || leftGesture == true){
    moving = true;
    if(yCollision){
      mainSprite.vx += -movementSpeed;
    } else {
      mainSprite.vx += -movementSpeedInAir;
    }
  } else {
    if(rightArrow.isDown || rightGesture == true){
        moving = true;
        if(yCollision){
           mainSprite.vx += movementSpeed;
        } else {
           mainSprite.vx += movementSpeedInAir;
        }
    } else {
        playerMovementAnimation = 0;
        if(jumped){
          mainSprite.texture = jumpCostume;
        } else {
          mainSprite.texture = idleCostume;
        }
    }
  }

  if(weaponCount > 0){
      mainSprite.texture = weaponCostume;
  } else {
    if(moving){
     if(jumped){
        mainSprite.texture = jumpCostume;
     } else {
        if(yCollision){
            playerMovementAnimation += Math.abs(mainSprite.vx * 1);
            if(playerMovementAnimation < 20){
              mainSprite.texture = run1Costume;
             } else if(playerMovementAnimation < 40){
              mainSprite.texture = run2Costume;
            } else if(playerMovementAnimation < 60){
              mainSprite.texture = run3Costume;
            } else if(playerMovementAnimation < 80){
              mainSprite.texture = run2Costume;
            } else {
               playerMovementAnimation += -80;
               mainSprite.texture = run1Costume;
            }
        } else {
            mainSprite.texture = idleCostume;
        }
      }
    }
   }

  

  mainSprite.vx = mainSprite.vx * velocityMultiplier;
  mainSprite.vy = mainSprite.vy * velocityMultiplier;
  mainSprite.vy += gravity;
 
  
  oldEnemyCollision = enemyCollision;
  enemyCollision = false;

  var enemyBeated = function(enemy){

    powerupSound.play();
    enemy.sprite.texture = cinghialeBeated;
    enemy.sprite.vx = 0;

    setTimeout(function(){
              stage.removeChild(enemy.sprite);
              enemy.sprite = null;
            },500);
    
  }

  for(var i = 0; i < platforms.length; i++){
    var enemies = platforms[i].enemies;
    if(enemies != null){
      for(var j = 0; j < enemies.length; j++){
        if(enemies[j].sprite == null)
          continue;

  	    enemies[j].sprite.x += enemies[j].sprite.vx; 
        enemies[j].sprite.y += enemies[j].sprite.vy; 

        if(enemies[j].sprite.x > TILE_SIZE_H * (platforms[i].col + platforms[i].width -1) + CONTROL_BUTTON_WIDTH){
          enemies[j].sprite.vx = -1;
          enemies[j].sprite.texture = cinghialeIdleL;
        } else if(enemies[j].sprite.x < TILE_SIZE_H * (platforms[i].col) + CONTROL_BUTTON_WIDTH){
          enemies[j].sprite.vx = 1;
          enemies[j].sprite.texture = cinghialeIdleR;
        }

	      if (hitTestRectangle(mainSprite, enemies[j].sprite)) {
          if(weaponCount>0 && ((mainSprite.x < enemies[j].sprite.x && mainSprite.vx > 0)
                           || (mainSprite.x > enemies[j].sprite.x && mainSprite.vx < 0))){
  
            enemyBeated(enemies[j]);
        } else {
            enemyCollision = true; 
          }
          weaponCount = 0;
        }
      }
    } 
  }

  if(enemyCollision && !oldEnemyCollision){
    power -= 10;
    
    //console.log('Uberfranz perde potenza...' + p);
    var p = power / 100 * $(".healt_bar").width();
    $(".healt_bar_inner").width(p);
    $(".healt_bar_inner").css("right", ( $(".healt_bar").width() - p )+ "px");
    if(power <=0){
      dieSound.play();
      /*var message = new PIXI.Text(
          "Game over",
          { font: "64px sans-serif", fill: "white"}
      );

      message.position.x = $(window).scrollLeft() + 20;
      message.position.y = $(window).scrollTop() + 20;
      controlLayerStage.addChild(message);*/
      stage.removeChild(mainSprite);

      state = gameOver;
      setTimeout(function(){
        $('.start_button').show();
      }, 500 );
    } else {
      enemyHitSound.play();  
      animation(bounce,function(delta) {
      //console.log(delta);
        //$("#display").css("left", to*delta + "px");    
        //stage.x = to*delta;
        mainSprite.y += -2*delta;
      });
    }
  }

  var main_width = main.width(); //Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
  var main_height = main.height(); //Math.max(document.documentElement.clientHeight, window.innerHeight || 0)


  var MAIN_SPRITE_WIDTH = mainSprite.width;
  var MAIN_SPRITE_HEIGTH = mainSprite.height;
  var hBorder = 200;
  var vBorder = 200;

//setTimeout(function(){  

  var scrollTop = main.scrollTop();
  if(mainSprite.y + MAIN_SPRITE_HEIGTH + vBorder > scrollTop + main_height){
    //console.log("out of screen - bottom");
    //$('.punch_left').html('out of screen');
    var scrollTo = mainSprite.y + MAIN_SPRITE_HEIGTH + vBorder - main_height;
    if(scrollTo > rendererHeight - main_height)
        scrollTo = rendererHeight - main_height;

       //$('.punch_left').html('out of screen ' + scrollTo);
    main.scrollTop(scrollTo);
  } else {
    if(mainSprite.y - hBorder < scrollTop ){
      //console.log("out of screen top");
      var scrollTo  = mainSprite.y - vBorder;
      if(scrollTo < 0)
        scrollTo = 0;
    main.scrollTop(scrollTo);
    }
  }

  
  var scrollLeft = main.scrollLeft();
  if(mainSprite.x + MAIN_SPRITE_WIDTH + hBorder > scrollLeft + main_width){
    //console.log("out of screen - right");
    var scrollTo = mainSprite.x + MAIN_SPRITE_WIDTH + hBorder - main_width;
    if(scrollTo > rendererWidth - main_width)
        scrollTo = rendererWidth - main_width;
    main.scrollLeft(scrollTo);
  } else {
    if(mainSprite.x - hBorder < scrollLeft ){
      //console.log("out of screen left");
      var scrollTo  = mainSprite.x - hBorder;
      if(scrollTo < 0)
        scrollTo = 0;
     main.scrollLeft(scrollTo);
    }
  }
//},0);

}

var changingLevel = function(){
  //
};

var gameOver = function(){
  //
};

var endWin = function(){
  //
};

/*
window.document.addEventListener('orientationchange', function() {
  var iOS = navigator.userAgent.match(/(iPad|iPhone|iPod)/g);
  var viewportmeta = document.querySelector('meta[name="viewport"]');
  if (iOS && viewportmeta) {
    if (viewportmeta.content.match(/width=device-width/)) {
      viewportmeta.content = viewportmeta.content.replace(/width=[^,]+/, 'width=1');
    }
    viewportmeta.content = viewportmeta.content.replace(/width=[^,]+/, 'width=' + window.innerWidth);
  }
  // If you want to hide the address bar on orientation change, uncomment the next line
  // window.scrollTo(0, 0);
}, false);*/

});



</script>
</head>

<body>
<div class="main">
<img src="images/play.jpeg" class="start_button" style="display:none;"></img>
<img src="images/squares.gif" class="loading" ></img>
<div class="punch_left" style="display:none"><img src="images/punch.png"></img></div>
<div class="punch_right" style="display:none"><img src="images/punch.png"></img></div>
<div class="healt_bar_container"><div class="healt_bar"><div class="healt_bar_inner"></div></div></div>
<div id="control_layer" class="control_layer"></div>
<div id="display" class="display"></div>
</div>
</body>
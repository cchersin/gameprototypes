<!doctype html>
<meta charset="utf-8">
<title>Uberfranz</title>
<head>
<style>
div.centre
/*{
  display: block;
  margin-left: auto;
  margin-right: auto;

}*/
</style>


<script src="js/levels.js"></script>
<script src="js/pixi.js"></script>
<script src="js/sound.js"></script>
<script src="js/tink.js"></script>
<script src="js/utils.js"></script>
<script src="js/jquery-3.1.1.min.js"></script>

<script>

$(function(){

var currLevel = 0;
var platforms = levels[currLevel].platforms;
var TILE_SIZE = 55;
var CONTROL_BUTTON_WIDTH = 0;
var CONTROL_BUTTON_HEIGHT = 0;
var power = 100;

///Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    Sprite = PIXI.Sprite,
    Rectangle = PIXI.Rectangle;

var rendererWidth = levels[currLevel].container.width*TILE_SIZE+CONTROL_BUTTON_WIDTH*2;
var rendererHeight = levels[currLevel].container.height*TILE_SIZE;

//Create the renderer
var renderer = autoDetectRenderer(rendererWidth, rendererHeight, 
                                  {antialias: false, transparent: false, resolution: 1});
renderer.backgroundColor = 0x061639;

renderer.view.style.position = "absolute";
renderer.view.style.display = "block";
renderer.autoResize = true;
//renderer.resize(window.innerWidth, window.innerHeight);

//Add the canvas to the HTML document
var display = $("#display");

display[0].appendChild(renderer.view);
//display.width(rendererWidth);
//display.height(rendererHeight);

document.body.addEventListener('touchmove', function(event) {
  event.preventDefault();
  console.log("touchmove");
}, false); 


var t = new Tink(PIXI, renderer.view);


//Create a container object called the `stage`
var stage = new Container();
var mainSprite = null;
var cinghialiSprite = [];
var winSprite;
var state = null;
var greenTile = null;
var weaponCount = 0;

//Capture the keyboard arrow keys
  var left = leftArrow,
      up = upArrow,
      right = rightArrow,
      down = downArrow;


loader
  .add("uberfranzIdleR", "images/uberfranz_idle_r.png")
  .add("uberfranzRun1R", "images/uberfranz_run1_r.png")
  .add("uberfranzRun2R", "images/uberfranz_run2_r.png")
  .add("uberfranzRun3R", "images/uberfranz_run3_r.png")
  .add("uberfranzJumpR", "images/uberfranz_jump_r.png")
  .add("uberfranzWeaponR", "images/uberfranz_weapon_r.png")
  .add("uberfranzIdleL", "images/uberfranz_idle_l.png")
  .add("uberfranzRun1L", "images/uberfranz_run1_l.png")
  .add("uberfranzRun2L", "images/uberfranz_run2_l.png")
  .add("uberfranzRun3L", "images/uberfranz_run3_l.png")
  .add("uberfranzJumpL", "images/uberfranz_jump_l.png")
  .add("uberfranzWeaponL", "images/uberfranz_weapon_l.png")
  .add("uberfranzDead", "images/uberfranz_dead.png")
  //.add("uberfranzBeatEnemy", "images/uberfranz.png")
  //.add("uberfranzMaglioDasburgo", "images/uberfranz.png")
  .add("cinghialeIdle", "images/cinghiale.png")
  //.add("cinghialeBeated", "images/cinghiale.png")
  .add("win", "images/win.png")
  .add("arrowRight","images/arrow_right.json")
  .load(setup);

  


var movementSpeed = 0.8;
var movementSpeedInAir = 0.1;
var gravity = 0.1;
var velocityMultiplier = 0.96;
var velocityMultiplierLand = 0.8;
var jumped = false;
var jumpHeight = 7;
var runJumpMultipler = 0.2;
var playerDead = 0;
var idleCostume = null;
var moving = false;
var xCollision = false;
var yCollision = false;
var playerMovementAnimation = 0;
var jumpSound = null;
var leftGesture = false;
var rightGesture = false;
var upGesture = false;




function createPlatformSprite(row,col,width,height,tileTexture){

  var platform = new Container();

  for(var i=0; i < width; i++){
    for(var j=0; j < height; j++){
       //var tile = new Sprite(tileTexture);
       var tile = new PIXI.Graphics();
       tile.lineStyle(1, 0xEEEEEE, 1);
       tile.beginFill(0xCCCCCC);
       tile.drawRect(0, 0, TILE_SIZE -2, TILE_SIZE-2);
       tile.endFill();
       tile.x = CONTROL_BUTTON_WIDTH + i * TILE_SIZE;
       tile.y = j * TILE_SIZE;
       platform.addChild(tile);
    }
  }

  platform.x = col * TILE_SIZE;
  platform.y = row * TILE_SIZE;

  return platform;
}

function hitPlatform(){
  for(var i= 0; i < platforms.length; i++){
   if(hitTestRectangle(mainSprite,platforms[i].sprite))
    return true;
  }

  return false;
}

/*var myDiv = document.getElementById("myDiv");
 
 
myDiv.addEventListener("touchstart", function() {
 
    coloreOriginario = myDiv.style.backgroundColor;
    myDiv.style.backgroundColor = "red";
});
 
 
myDiv.addEventListener("touchend", function() {
 
    myDiv.style.backgroundColor = coloreOriginario;
});*/

var leftCostumes = function(){
    idleCostume = resources.uberfranzIdleL.texture;
    run1Costume = resources.uberfranzRun1L.texture;
    run2Costume = resources.uberfranzRun2L.texture;
    run3Costume = resources.uberfranzRun3L.texture;
    jumpCostume = resources.uberfranzJumpL.texture;
    weaponCostume = resources.uberfranzWeaponL.texture;
}

var rightCostumes = function(){
    idleCostume = resources.uberfranzIdleR.texture;
    run1Costume = resources.uberfranzRun1R.texture;
    run2Costume = resources.uberfranzRun2R.texture;
    run3Costume = resources.uberfranzRun3R.texture;
    jumpCostume = resources.uberfranzJumpR.texture;
    weaponCostume = resources.uberfranzWeaponR.texture;
}

function detectActions(touches){
  leftGesture = false;
  rightGesture = false;
  upGesture = false;
  for (var i = touches.length - 1; i >= 0; i--) {
    if(touches[i].clientX < rendererWidth / 3){
      leftCostumes();
      leftGesture = true;
    } else if(touches[i].clientX > rendererWidth * 2 / 3){
      rightCostumes();
      rightGesture = true;
    } else {
      upGesture = true;
    }
  };
}

var cachedX = -1;
var cached2 = -1;

$(window).on("touchstart", function(ev) {
    var e = ev.originalEvent;
    //console.log(e.touches);
    detectActions(e.touches);

    var currX = e.pageX;
    var currY = e.pageY;

    cachedX = currX;
    cachedY = currY;

    setTimeout(function(){ cachedX=-1; cachedy=-1; }, 200);

});

$(window).on("touchend", function(ev) {
    var e = ev.originalEvent;
  //  console.log(e.touches);
    detectActions(e.touches);

    var currX = e.pageX;
    var currY = e.pageY;

    if((cachedX == currX) && (cachedY == currY)){
      upGesture = true;
      setTimeout(function(){ upGesture = false; }, 200);
    }
});




function setup() {

  //Load the sounds
  sounds.load([
  "sounds/bounce.mp3", 
   ]);
  sounds.whenLoaded = setupSounds;

  function setupSounds(){
    jumpSound = sounds["sounds/bounce.mp3"];

 
  rightCostumes();
  
  weaponCostume = resources.uberfranzWeaponR.texture;
  deadCostume = resources.uberfranzDead.texture;
  /*uberfranzBeatEnemy = resources.uberfranzBeatEnemy.texture;*/
  cinghialeIdle = resources.cinghialeIdle.texture;
  /*cinghialeBeated = resources.cinghialeBeated.texture; TODO ....*/


  var uberfranzSprite = new Sprite(
    idleCostume
  );

  var weaponKey = keyboard(65);


  for(var i = 0; i < platforms.length; i++){
    platforms[i].sprite = createPlatformSprite(platforms[i].row, platforms[i].col, platforms[i].width, platforms[i].height,null);
    stage.addChild(platforms[i].sprite);

    if(platforms[i].enemies != null){
      var enemies = platforms[i].enemies;

      for(var j = 0; j < enemies.length; j++ ){
       var cinghialeSprite = new Sprite(
         resources.cinghialeIdle.texture
       );

       cinghialeSprite.x = TILE_SIZE * (platforms[i].col + enemies[j].col) + CONTROL_BUTTON_WIDTH;
       cinghialeSprite.y = (TILE_SIZE * platforms[i].row) - cinghialeSprite.height;
       cinghialeSprite.vx = -1;
       cinghialeSprite.vy = 0;

       stage.addChild(cinghialeSprite);

       enemies[j].sprite = cinghialeSprite;
      }
    }
  }


  winSprite = new Sprite(
    resources.win.texture
  );
  winSprite.x = 180;
  stage.addChild(winSprite);
  
  mainSprite = uberfranzSprite;

 //console.log(levels[currLevel].mainCharacter.col + "-" + levels[currLevel].mainCharacter.row);

  mainSprite.x = levels[currLevel].mainCharacter.col * TILE_SIZE;
  mainSprite.y = levels[currLevel].mainCharacter.row * TILE_SIZE;
  mainSprite.vx = 0;
  mainSprite.vy = 0;

  //console.log(mainSprite.x + "-" + mainSprite.y);

  stage.addChild(mainSprite);


  var pointer = t.makePointer();
  pointer.visible=true;
  pointer.x=0;
  pointer.y=0;


  weaponKey.press = function() {
    weaponCount++;

    setTimeout(function(){ if( weaponCount > 0 )
                              weaponCount--; }, 500);
  };

  left.press = function(){
    leftCostumes();
  }

  right.press = function(){
     rightCostumes();
  }

  state = play;
  gameLoop();
 }

}


function gameLoop() {

  //Loop this function at 60 frames per second
  requestAnimationFrame(gameLoop);

  //Update the current game state:
  state();

  //Update Tink
  t.update();

  //Render the stage to see the animation
  renderer.render(stage);
}

function play() {

  mainSprite.texture = idleCostume;
  moving = false;
  xCollision = false;
  yCollision = false;


  mainSprite.x += mainSprite.vx;
  if(hitPlatform()){
    xCollision = true;
  }
  if(xCollision){
      mainSprite.y += Math.abs(mainSprite.vx/2);
      if(hitPlatform()){
        mainSprite.y += Math.abs(mainSprite.vx/2);
        if(hitPlatform()){
          mainSprite.y += Math.abs(mainSprite.vx/2);
          if(hitPlatform()){
            mainSprite.y += Math.abs(mainSprite.vx/2);
            if(hitPlatform()){
               mainSprite.y += - Math.abs(mainSprite.vx/2)*4;
               mainSprite.x += -mainSprite.vx;
               mainSprite.vx = 0;
            } else {
              mainSprite.y += -Math.abs(mainSprite.vx/2);
            }
          } else {
            mainSprite.y += -Math.abs(mainSprite.vx/2);
          }
        } else {
          mainSprite.y += -Math.abs(mainSprite.vx/2);
        }
      } else {
        mainSprite.y += -Math.abs(mainSprite.vx/2);
      }
  }
  
  mainSprite.y += mainSprite.vy;
  if(hitPlatform()){
    yCollision = true;
  }

  if(yCollision){
    mainSprite.vx = mainSprite.vx * velocityMultiplierLand;
    if((upArrow.isDown || upGesture) && mainSprite.vy > 0){
      mainSprite.vy = -(jumpHeight * (1 + Math.abs(mainSprite.vx * runJumpMultipler)));
      jumped = true;
      jumpSound.play();
    } else {
       if(mainSprite.vy > 0){
          jumped = false;
       }
       mainSprite.y += - mainSprite.vy;
       mainSprite.vy = 0;
    }
  }

  if( jumped && (!(upArrow.isDown || upGesture) && mainSprite.vy < 0)){
    mainSprite.vy = mainSprite.vy * 0.6;
  }

  // Se sta toccando die allora
  if(hitTestRectangle(mainSprite,winSprite)){
    console.log('win');
  }
  // Se sta toccando win allora

  if(leftArrow.isDown || leftGesture == true){
    moving = true;
    //mainSprite.anchor.x = 0;
    //mainSprite.scale.x = 1;

    if(yCollision){
      mainSprite.vx += -movementSpeed;
    } else {
      mainSprite.vx += -movementSpeedInAir;
    }
  } else {
    if(rightArrow.isDown || rightGesture == true){
        moving = true;
        //mainSprite.anchor.x = 1;
        //mainSprite.scale.x = -1;
   
     
        if(yCollision){
           mainSprite.vx += movementSpeed;
        } else {
           mainSprite.vx += movementSpeedInAir;
        }
    } else {
        //mainSprite.anchor.x = 0;
        playerMovementAnimation = 0;
        if(jumped){
          mainSprite.texture = jumpCostume;
        } else {
          mainSprite.texture = idleCostume;
        }
    }
  }

  if(moving){
    if(weaponCount > 0){
      mainSprite.texture = weaponCostume;
    } else {
     if(jumped){
        mainSprite.texture = jumpCostume;
     } else {
        if(yCollision){
            playerMovementAnimation += Math.abs(mainSprite.vx * 1);
            if(playerMovementAnimation < 20){
              mainSprite.texture = run1Costume;
             } else if(playerMovementAnimation < 40){
              mainSprite.texture = run2Costume;
            } else if(playerMovementAnimation < 60){
              mainSprite.texture = run3Costume;
            } else if(playerMovementAnimation < 80){
              mainSprite.texture = run2Costume;
            } else {
               playerMovementAnimation += -80;
               mainSprite.texture = run1Costume;
            }
        } else {
            mainSprite.texture = idleCostume;
        }
      }
    }
   }

  

  mainSprite.vx = mainSprite.vx * velocityMultiplier;
  mainSprite.vy = mainSprite.vy * velocityMultiplier;
  mainSprite.vy += gravity;
 
  
  for(var i = 0; i < platforms.length; i++){
    var enemies = platforms[i].enemies;
    if(enemies != null){
      for(var j = 0; j < enemies.length; j++){
        if(enemies[j].sprite == null)
          continue;

  	    enemies[j].sprite.x += enemies[j].sprite.vx; 
        enemies[j].sprite.y += enemies[j].sprite.vy; 

        if(enemies[j].sprite.x > TILE_SIZE * (platforms[i].col + platforms[i].width -1) + CONTROL_BUTTON_WIDTH){
          enemies[j].sprite.vx = -1;
          enemies[j].sprite.scale.x = 1;
        } else if(enemies[j].sprite.x < TILE_SIZE * (platforms[i].col + 1) + CONTROL_BUTTON_WIDTH){
          enemies[j].sprite.vx = 1;
          enemies[j].sprite.scale.x = -1;
        }

	      //check for a collision between the cat and the box
	      if (hitTestRectangle(mainSprite, enemies[j].sprite)) {
          if(weaponCount>0 && ((mainSprite.x < enemies[j].sprite.x && mainSprite.vx > 0)
                           || (mainSprite.x > enemies[j].sprite.x && mainSprite.vx < 0))){
            console.log('Cinghiale steso!!!');
            stage.removeChild(enemies[j].sprite);
            enemies[j].sprite = null;
          } else {
            power -= 10;
            console.log('Uberfranz perde potenza...');
            if(power <=0){
              console.log('lose');
            }
          }
          weaponCount = 0;
        }
      }
    } 
  }

 // var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
//var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0)

var MAIN_SPRITE_HEIGTH = 48;
var scrollTop = $(window).scrollTop();
if(mainSprite.y + MAIN_SPRITE_HEIGTH * 2 > scrollTop + $(window).height()){
    //console.log("out of screen - bottom");
    var scrollTo = mainSprite.y + MAIN_SPRITE_HEIGTH * 6 - $(window).height();
    scrollTo = Math.ceil(scrollTo / TILE_SIZE) * TILE_SIZE;
    if(scrollTo > rendererHeight - $(window).height())
        scrollTo = rendererHeight - $(window).height();
    $(window).scrollTop(scrollTo);
} else {

  if(mainSprite.y - MAIN_SPRITE_HEIGTH < scrollTop ){
      //console.log("out of screen top");
      var scrollTo  = mainSprite.y - MAIN_SPRITE_HEIGTH * 3;
      scrollTo = Math.floor(scrollTo / TILE_SIZE) * TILE_SIZE;
      if(scrollTo < 0)
        scrollTo = 0;
     $(window).scrollTop(scrollTo);
  }
}

var MAIN_SPRITE_WIDTH = 48;
var scrollLeft = $(window).scrollLeft();
if(mainSprite.x + MAIN_SPRITE_WIDTH * 2 > scrollLeft + $(window).width()){
    //console.log("out of screen - right");
    var scrollTo = mainSprite.x + MAIN_SPRITE_WIDTH * 6 - $(window).width();
    scrollTo = Math.ceil(scrollTo / TILE_SIZE) * TILE_SIZE;
    if(scrollTo > rendererWidth - $(window).width())
        scrollTo = rendererWidth - $(window).width();
    $(window).scrollLeft(scrollTo);
} else {

  if(mainSprite.x - MAIN_SPRITE_HEIGTH < scrollLeft ){
      //console.log("out of screen left");
      var scrollTo  = mainSprite.x - MAIN_SPRITE_WIDTH * 3;
      scrollTo = Math.floor(scrollTo / TILE_SIZE) * TILE_SIZE;
      if(scrollTo < 0)
        scrollTo = 0;
     $(window).scrollLeft(scrollTo);
  }
}




}

});

</script>
</head>

<body>
<div id="display" class="centre"></div>
</body>
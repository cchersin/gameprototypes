<!doctype html>
<meta charset="utf-8">
<title>Uberfranz</title>
<head>
<style>
.main {
  position: relative;
  height: 100px;
  width: 100%;
}

.punch_left {
  position: fixed;
  top: 100px;
  right: 0px;
  z-index: 999;
}

.punch_right {
  position: fixed;
  top: 100px;
  left: 0px;
  z-index: 999;
}

.healt_bar_container {
  position: fixed;
  top: 0px;
  left: 0px;
  right: 0px;
  max-width: 1100px;
  height: 20px;
  z-index: 999;
}

.healt_bar {
  position: absolute;
  top: 10px;
  right: 20px;
  height: 5px;
  width: 150px;
  background-color: blue;
}


.healt_bar_inner {
  position: absolute;
  top: 0px;
  right: 0px;
  height: 5px;
  width: 150px;
  background-color: red;
}

.display {
  position: absolute;
  height: 100px;
  top: 0px;
  left: 0px;
 }
</style>


<script src="js/pixi.js"></script>
<script src="js/sound.js"></script>
<script src="js/tink.js"></script>
<script src="js/utils.js"></script>
<script src="js/jquery-3.1.1.min.js"></script>

<script>


$(function(){

if(navigator.userAgent.includes('Silk/')){
  $(document.body).html('Silk browser not suppported');
  return;
}

function detectmob() { 
 if( navigator.userAgent.match(/Android/i)
 || navigator.userAgent.match(/webOS/i)
 || navigator.userAgent.match(/iPhone/i)
 || navigator.userAgent.match(/iPad/i)
 || navigator.userAgent.match(/iPod/i)
 || navigator.userAgent.match(/BlackBerry/i)
 || navigator.userAgent.match(/Windows Phone/i)
 ){
    return true;
  }
 else {
    return false;
  }
}

if(detectmob()){
  $(".punch_right").show();
  $(".punch_left").show();
}


var levels = [{
  container:{width:20,height:13},
  mainCharacter:{row:10,col:10},
  platforms:[{row:11,col:0, width:20, height:2},
         {row:0,col:0, width:1, height:11},
         {row:0,col:19, width:1, height:11},
             {row:3,col:1, width:3, height:1},
         {row:5,col:1, width:6, height:1, enemies : [{col:1},{col:3}]},
         {row:6.8,col:9, width:10, height:1},
         {row:9,col:5, width:14, height:1, enemies : [{col:1}]}]},
   { container:{width:20,height:13},
   mainCharacter:{row:10,col:10},
   platforms:[{row:11,col:0, width:20, height:2},
         {row:0,col:0, width:1, height:11},
         {row:0,col:19, width:1, height:11},
             {row:3,col:1, width:3, height:1},
         {row:5,col:1, width:6, height:1, enemies : [{col:1},{col:3}]},
         {row:6.8,col:9, width:10, height:1},
         {row:9,col:5, width:14, height:1, enemies : [{col:1}]}]},
  { container:{width:20,height:13},
   mainCharacter:{row:10,col:10},
   platforms:[{row:11,col:0, width:20, height:2},
         {row:0,col:0, width:1, height:11},
         {row:0,col:19, width:1, height:11},
             {row:3,col:1, width:3, height:1},
         {row:5,col:1, width:6, height:1, enemies : [{col:1},{col:3}]},
         {row:6.8,col:9, width:10, height:1},
         {row:9,col:5, width:14, height:1, enemies : [{col:1}]}]}
];



var currLevel = 0;
var platforms = null; 
var TILE_SIZE = 55;
var CONTROL_BUTTON_WIDTH = 0;
var CONTROL_BUTTON_HEIGHT = 0;
var power = 100;


///Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    Sprite = PIXI.Sprite,
    Rectangle = PIXI.Rectangle;

var rendererWidth = levels[currLevel].container.width*TILE_SIZE+CONTROL_BUTTON_WIDTH*2;
var rendererHeight = levels[currLevel].container.height*TILE_SIZE;

//Create the renderer
var renderer = autoDetectRenderer(rendererWidth, rendererHeight, 
                                  {antialias: false, transparent: false, resolution: 1});
renderer.backgroundColor = 0x061639;

renderer.view.style.position = "absolute";
renderer.view.style.display = "block";
renderer.autoResize = true;
//renderer.resize(window.innerWidth, window.innerHeight);



//Add the canvas to the HTML document
var display = $("#display");

display[0].appendChild(renderer.view);
//display.width(rendererWidth);
//display.height(rendererHeight);

// TODO RESTART!!!!
// TODO dimesioni sprites 

var t = new Tink(PIXI, renderer.view);


var stage = null;
var uberfranzSprite = null;
var mainSprite = null;
var cinghialiSprite = [];
var doorSprite = null;
var winSprite = null;
//var punchSprite = null;
var state = null;
var greenTile = null;
var weaponCount = 0;
var stageX = 0;

//Capture the keyboard arrow keys
var left = leftArrow,
    up = upArrow,
    right = rightArrow,
    down = downArrow;
var weaponKey = keyboard(65);


loader
  .add("uberfranzIdleR", "images/uberfranz_idle_r.png")
  .add("uberfranzRun1R", "images/uberfranz_run1_r.png")
  .add("uberfranzRun2R", "images/uberfranz_run2_r.png")
  .add("uberfranzRun3R", "images/uberfranz_run3_r.png")
  .add("uberfranzJumpR", "images/uberfranz_jump_r.png")
  .add("uberfranzWeaponR", "images/uberfranz_weapon_r.png")
  .add("uberfranzIdleL", "images/uberfranz_idle_l.png")
  .add("uberfranzRun1L", "images/uberfranz_run1_l.png")
  .add("uberfranzRun2L", "images/uberfranz_run2_l.png")
  .add("uberfranzRun3L", "images/uberfranz_run3_l.png")
  .add("uberfranzJumpL", "images/uberfranz_jump_l.png")
  .add("uberfranzWeaponL", "images/uberfranz_weapon_l.png")
  .add("uberfranzDead", "images/uberfranz_dead.png")
  //.add("uberfranzBeatEnemy", "images/uberfranz.png")
  //.add("uberfranzMaglioDasburgo", "images/uberfranz.png")
  .add("cinghialeIdle", "images/cinghiale.png")
  .add("cinghialeBeated", "images/cinghiale_beated.png")
  .add("win", "images/win.png")
  //.add("punch","images/punch.png")
  .load(onSetupImages);

  

var movementSpeed = 0.8;
var movementSpeedInAir = 0.1;
var gravity = 0.1;
var velocityMultiplier = 0.96;
var velocityMultiplierLand = 0.8;
var jumped = false;
var jumpHeight = 7;
var runJumpMultipler = 0.2;
var playerDead = 0;
var idleCostume = null;
var moving = false;
var xCollision = false;
var oldYCollions = false;
var yCollision = false;
var playerMovementAnimation = 0;
var jumpSound = null;
var enemyHitSound = null;
var dieSound = null;
var punchSound = null;
var powerupSound = null;
var enterDoorSound = null;
var winSound = null;
var leftGesture = false;
var rightGesture = false;
var upGesture = false;
var enemyCollision = false;
var oldEnemyCollision = false;






function createPlatformSprite(row,col,width,height,tileTexture){

  var platform = new Container();

  for(var i=0; i < width; i++){
    for(var j=0; j < height; j++){
       //var tile = new Sprite(tileTexture);
       var tile = new PIXI.Graphics();
       tile.lineStyle(1, 0xEEEEEE, 1);
       tile.beginFill(0xCCCCCC);
       tile.drawRect(0, 0, TILE_SIZE -2, TILE_SIZE-2);
       tile.endFill();
       tile.x = CONTROL_BUTTON_WIDTH + i * TILE_SIZE;
       tile.y = j * TILE_SIZE;
       platform.addChild(tile);
    }
  }

  platform.x = col * TILE_SIZE;
  platform.y = row * TILE_SIZE;

  return platform;
}

function hitPlatform(){
  for(var i= 0; i < platforms.length; i++){
   if(hitTestRectangle(mainSprite,platforms[i].sprite))
    return true;
  }

  return false;
}

var leftCostumes = function(){
    idleCostume = resources.uberfranzIdleL.texture;
    run1Costume = resources.uberfranzRun1L.texture;
    run2Costume = resources.uberfranzRun2L.texture;
    run3Costume = resources.uberfranzRun3L.texture;
    jumpCostume = resources.uberfranzJumpL.texture;
    weaponCostume = resources.uberfranzWeaponL.texture;
}

var rightCostumes = function(){
    idleCostume = resources.uberfranzIdleR.texture;
    run1Costume = resources.uberfranzRun1R.texture;
    run2Costume = resources.uberfranzRun2R.texture;
    run3Costume = resources.uberfranzRun3R.texture;
    jumpCostume = resources.uberfranzJumpR.texture;
    weaponCostume = resources.uberfranzWeaponR.texture;
}

function detectActions(touches){

 if(touches.length == 2){  
    upGesture = true;
  } else { 
  
    leftGesture = false;
    rightGesture = false;
    upGesture = false;

    for (var i = touches.length - 1; i >= 0; i--) {
      if(touches[i].clientX < rendererWidth / 2  ){
        leftCostumes();
        leftGesture = true;
      } else if((touches[i].clientX > rendererWidth / 2 ) && touches[i].pageY > 100){
        rightCostumes();
        rightGesture = true;
      } 
    }
  }
}

$(".display").on("touchstart", function(ev) {
    var e = ev.originalEvent;
    //console.log(e.touches);
    detectActions(e.touches);
});

$(".display").on("touchend", function(ev) {
    var e = ev.originalEvent;
    //console.log(e.touches);
    detectActions(e.touches);
});

document.body.addEventListener('touchmove', function(event) {
  event.preventDefault();
}, false); 

var punch = function(){
    if(state != play)
      return;

    punchSound.play();
    weaponCount++;
    setTimeout(function(){ if( weaponCount > 0 )
                              weaponCount--; }, 500);
    animation(bounce2,function(delta) {
      console.log(delta);
        //$("#display").css("left", to*delta + "px");    
        //stage.x = to*delta;
        stageX = 10*(delta);
        //stageX = - 20;
    });
}

$(".punch_left").click(function() {
    punch();
});

$(".punch_right").click(function() {
   punch();
  });

$(".punch_left").on("touchstart", function(ev) {
    punch();
});

$(".punch_right").on("touchstart", function(ev) {
    punch();
});

function onSetupImages() {

  weaponCostume = resources.uberfranzWeaponR.texture;
  deadCostume = resources.uberfranzDead.texture;
  /*uberfranzBeatEnemy = resources.uberfranzBeatEnemy.texture;*/
  cinghialeIdle = resources.cinghialeIdle.texture;
  cinghialeBeated = resources.cinghialeBeated.texture;

  uberfranzSprite = new Sprite(
    idleCostume
  );

  rightCostumes();

  //Load the sounds
  sounds.load([
    "sounds/jump.wav",
    "sounds/enemy_hit.wav",  
    "sounds/die.wav",  
    "sounds/punch.wav",
    "sounds/enter_door.wav",
    "sounds/powerup.wav",
    "sounds/win.wav"
   ]);

  sounds.whenLoaded = onSetupSounds;

  function onSetupSounds(){
    jumpSound = sounds["sounds/jump.wav"];
    enemyHitSound = sounds["sounds/enemy_hit.wav"];
    dieSound = sounds["sounds/die.wav"];
    punchSound = sounds["sounds/punch.wav"];
    enterDoorSound = sounds["sounds/enter_door.wav"];
    powerupSound = sounds["sounds/powerup.wav"];
    winSound = sounds["sounds/win.wav"];


    setupLevel();
    gameLoop();
  }
}

function setupLevel(){

  stage = new Container();

  platforms = levels[currLevel].platforms;
 
  uberfranzSprite.texture = idleCostume;
  rightCostumes();  


  for(var i = 0; i < platforms.length; i++){
    platforms[i].sprite = createPlatformSprite(platforms[i].row, platforms[i].col, platforms[i].width, platforms[i].height,null);
    stage.addChild(platforms[i].sprite);

    if(platforms[i].enemies != null){
      var enemies = platforms[i].enemies;

      for(var j = 0; j < enemies.length; j++ ){
       var cinghialeSprite = new Sprite(
         resources.cinghialeIdle.texture
       );

       cinghialeSprite.x = TILE_SIZE * (platforms[i].col + enemies[j].col) + CONTROL_BUTTON_WIDTH;
       cinghialeSprite.y = (TILE_SIZE * platforms[i].row) - cinghialeSprite.height;
       cinghialeSprite.vx = -1;
       cinghialeSprite.vy = 0;

       stage.addChild(cinghialeSprite);

       enemies[j].sprite = cinghialeSprite;
      }
    }
  }
  
  winSprite = new PIXI.Graphics();
  winSprite.lineStyle(1, 0xEEEEEE, 1);
  winSprite.beginFill(0xCCCCCC);
  winSprite.drawRect(0, 0, 20, 20);
  winSprite.endFill();
  winSprite.x = 90;
  winSprite.y = 40;
  stage.addChild(winSprite);

  doorSprite = new Sprite(
    resources.win.texture
  );
  doorSprite.x = 50;
  stage.addChild(doorSprite);

  /*punchSprite = new Sprite(
    resources.punch.texture
  );
  punchSprite.x = rendererWidth - 100;
  stage.addChild(punchSprite);
  t.makeInteractive(punchSprite);

  punchSprite.press = function() {
   weaponPressed = true;
  };

  punchSprite.release = function()  {
    weaponPressed = false;
  };*/

  
  mainSprite = uberfranzSprite;

 //console.log(levels[currLevel].mainCharacter.col + "-" + levels[currLevel].mainCharacter.row);

  mainSprite.x = levels[currLevel].mainCharacter.col * TILE_SIZE;
  mainSprite.y = levels[currLevel].mainCharacter.row * TILE_SIZE;
  mainSprite.vx = 0;
  mainSprite.vy = 0;

  //console.log(mainSprite.x + "-" + mainSprite.y);

  stage.addChild(mainSprite);


  var pointer = t.makePointer();
  pointer.visible=true;
  pointer.x=0;
  pointer.y=0;


  weaponKey.press = function() {
    punch();
  };

  left.press = function(){
    leftCostumes();
  }

  right.press = function(){
     rightCostumes();
  }

  state = play;
}




function gameLoop() {

  //Loop this function at 60 frames per second
  requestAnimationFrame(gameLoop);

  //Update the current game state:
  state();

  //Update Tink
  t.update();

  //Render the stage to see the animation
  renderer.render(stage);
}

function play() {
  
  oldYCollions = yCollision;
  stage.x = stageX;

  mainSprite.texture = idleCostume;
  moving = false;
  xCollision = false;
  yCollision = false;

 //punchSprite.y = $(window).scrollTop();

  mainSprite.x += mainSprite.vx;
  if(hitPlatform()){
    xCollision = true;
  }
  if(xCollision){
      mainSprite.y += Math.abs(mainSprite.vx/2);
      if(hitPlatform()){
        mainSprite.y += Math.abs(mainSprite.vx/2);
        if(hitPlatform()){
          mainSprite.y += Math.abs(mainSprite.vx/2);
          if(hitPlatform()){
            mainSprite.y += Math.abs(mainSprite.vx/2);
            if(hitPlatform()){
               mainSprite.y += - Math.abs(mainSprite.vx/2)*4;
               mainSprite.x += -mainSprite.vx;
               mainSprite.vx = 0;
            } else {
              mainSprite.y += -Math.abs(mainSprite.vx/2);
            }
          } else {
            mainSprite.y += -Math.abs(mainSprite.vx/2);
          }
        } else {
          mainSprite.y += -Math.abs(mainSprite.vx/2);
        }
      } else {
        mainSprite.y += -Math.abs(mainSprite.vx/2);
      }
  }
  
  mainSprite.y += mainSprite.vy;
  if(hitPlatform()){
    yCollision = true;
  }


  if(!oldYCollions && yCollision){
      animation(bounce,function(delta) {
      //console.log(delta);
        //$("#display").css("left", to*delta + "px");    
        //stage.x = to*delta;
        stage.y = 10*delta;
      });
  }

  if(yCollision){
    mainSprite.vx = mainSprite.vx * velocityMultiplierLand;
    if((upArrow.isDown || upGesture) && mainSprite.vy > 0){
      mainSprite.vy = -(jumpHeight * (1 + Math.abs(mainSprite.vx * runJumpMultipler)));
      jumped = true;
      jumpSound.play();
    } else {
       if(mainSprite.vy > 0){
          jumped = false;
       }
       mainSprite.y += - mainSprite.vy;
       mainSprite.vy = 0;
    }
  }

  if( jumped && (!(upArrow.isDown || upGesture) && mainSprite.vy < 0)){
    mainSprite.vy = mainSprite.vy * 0.6;
  }

  if(hitTestRectangle(mainSprite,winSprite)){
    stage.removeChild(mainSprite);
    if(currLevel == levels.length -1){
      winSound.play();
      state = endWin;
    } else {
      enterDoorSound.play();
      state = changingLevel;
      currLevel++; 
      setTimeout(function(){
        setupLevel();
      }, 500);
    }
    return;
  }


  if(leftArrow.isDown || leftGesture == true){
    moving = true;
    if(yCollision){
      mainSprite.vx += -movementSpeed;
    } else {
      mainSprite.vx += -movementSpeedInAir;
    }
  } else {
    if(rightArrow.isDown || rightGesture == true){
        moving = true;
        if(yCollision){
           mainSprite.vx += movementSpeed;
        } else {
           mainSprite.vx += movementSpeedInAir;
        }
    } else {
        playerMovementAnimation = 0;
        if(jumped){
          mainSprite.texture = jumpCostume;
        } else {
          mainSprite.texture = idleCostume;
        }
    }
  }

  if(weaponCount > 0){
      mainSprite.texture = weaponCostume;
  } else {
    if(moving){
     if(jumped){
        mainSprite.texture = jumpCostume;
     } else {
        if(yCollision){
            playerMovementAnimation += Math.abs(mainSprite.vx * 1);
            if(playerMovementAnimation < 20){
              mainSprite.texture = run1Costume;
             } else if(playerMovementAnimation < 40){
              mainSprite.texture = run2Costume;
            } else if(playerMovementAnimation < 60){
              mainSprite.texture = run3Costume;
            } else if(playerMovementAnimation < 80){
              mainSprite.texture = run2Costume;
            } else {
               playerMovementAnimation += -80;
               mainSprite.texture = run1Costume;
            }
        } else {
            mainSprite.texture = idleCostume;
        }
      }
    }
   }

  

  mainSprite.vx = mainSprite.vx * velocityMultiplier;
  mainSprite.vy = mainSprite.vy * velocityMultiplier;
  mainSprite.vy += gravity;
 
  
  oldEnemyCollision = enemyCollision;
  enemyCollision = false;

  var enemyBeated = function(enemy){

    powerupSound.play();
    enemy.sprite.texture = cinghialeBeated;
    enemy.sprite.vx = 0;

    setTimeout(function(){
              stage.removeChild(enemy.sprite);
              enemy.sprite = null;
            },500);
    
  }

  for(var i = 0; i < platforms.length; i++){
    var enemies = platforms[i].enemies;
    if(enemies != null){
      for(var j = 0; j < enemies.length; j++){
        if(enemies[j].sprite == null)
          continue;

  	    enemies[j].sprite.x += enemies[j].sprite.vx; 
        enemies[j].sprite.y += enemies[j].sprite.vy; 

        if(enemies[j].sprite.x > TILE_SIZE * (platforms[i].col + platforms[i].width -1) + CONTROL_BUTTON_WIDTH){
          enemies[j].sprite.vx = -1;
          enemies[j].sprite.scale.x = 1;
        } else if(enemies[j].sprite.x < TILE_SIZE * (platforms[i].col + 1) + CONTROL_BUTTON_WIDTH){
          enemies[j].sprite.vx = 1;
          enemies[j].sprite.scale.x = -1;
        }

	      if (hitTestRectangle(mainSprite, enemies[j].sprite)) {
          if(weaponCount>0 && ((mainSprite.x < enemies[j].sprite.x && mainSprite.vx > 0)
                           || (mainSprite.x > enemies[j].sprite.x && mainSprite.vx < 0))){
  
            enemyBeated(enemies[j]);
        } else {
            enemyCollision = true; 
          }
          weaponCount = 0;
        }
      }
    } 
  }

  if(enemyCollision && !oldEnemyCollision){
    power -= 10;
    
    //console.log('Uberfranz perde potenza...' + p);
    var p = power / 100 * $(".healt_bar").width();
    $(".healt_bar_inner").width(p);
    $(".healt_bar_inner").css("right", 20 + ( $(".healt_bar").width() - p )+ "px");
    if(power <=0){
      dieSound.play();
      var message = new PIXI.Text(
          "Game over",
          { font: "64px sans-serif", fill: "white"}
      );

      message.position.x = $(window).scrollLeft() + 20;
      message.position.y = $(window).scrollTop() + 20;
      stage.addChild(message);
      stage.removeChild(mainSprite);

      state = gameOver;
    } else {
      enemyHitSound.play();  
    }
  }

  // var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
  //var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0)

  var hBorder = rendererWidth / 6;
  var vBorder = rendererHeight / 6;

  var MAIN_SPRITE_HEIGTH = 48;
  var scrollTop = $(window).scrollTop();
  if(mainSprite.y + MAIN_SPRITE_HEIGTH + vBorder > scrollTop + $(window).height()){
    //console.log("out of screen - bottom");
    var scrollTo = mainSprite.y + MAIN_SPRITE_HEIGTH + hBorder - $(window).height();
    //scrollTo = Math.ceil(scrollTo / TILE_SIZE) * TILE_SIZE;
    if(scrollTo > rendererHeight - $(window).height())
        scrollTo = rendererHeight - $(window).height();
    $(window).scrollTop(scrollTo);
  } else {
    if(mainSprite.y - hBorder < scrollTop ){
      //console.log("out of screen top");
      var scrollTo  = mainSprite.y - hBorder;
      //scrollTo = Math.floor(scrollTo / TILE_SIZE) * TILE_SIZE;
      if(scrollTo < 0)
        scrollTo = 0;
     $(window).scrollTop(scrollTo);
    }
  }

  var MAIN_SPRITE_WIDTH = 48;
  var scrollLeft = $(window).scrollLeft();
  if(mainSprite.x + MAIN_SPRITE_WIDTH + hBorder > scrollLeft + $(window).width()){
    //console.log("out of screen - right");
    var scrollTo = mainSprite.x + MAIN_SPRITE_WIDTH + hBorder - $(window).width();
    //scrollTo = Math.ceil(scrollTo / TILE_SIZE) * TILE_SIZE;
    if(scrollTo > rendererWidth - $(window).width())
        scrollTo = rendererWidth - $(window).width();
    $(window).scrollLeft(scrollTo);
  } else {
    if(mainSprite.x - hBorder < scrollLeft ){
      //console.log("out of screen left");
      var scrollTo  = mainSprite.x - hBorder;
      //scrollTo = Math.floor(scrollTo / TILE_SIZE) * TILE_SIZE;
      if(scrollTo < 0)
        scrollTo = 0;
     $(window).scrollLeft(scrollTo);
    }
  }

}

var changingLevel = function(){
  //
};

var gameOver = function(){
  //
};

var endWin = function(){
  //
};

});



</script>
</head>

<body>
<div class="main">
<div class="punch_left" style="display:none"><img src="images/punch.png"></img></div>
<div class="punch_right" style="display:none"><img src="images/punch.png"></img></div>
<div class="healt_bar_container"><div class="healt_bar"><div class="healt_bar_inner"></div></div></div>
<div id="display" class="display"></div>
</div>
</body>